<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="stylesheets/style.css">
    <meta charset="UTF-8">
    <title>Job Tracker</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        var srch = window.location.search;

        var writeLog = function (logMsg) {
            if (document.getElementById("logArea").style.visibility === 'visible') {
                var logA = document.getElementById("logArea");
                logA.innerHTML = logMsg + "<br>" + logA.innerHTML;
            }
        };

        var processEvent = function (event, src){
            //var logArea = document.getElementById("logArea");
            var tableArea = document.getElementById("tableArea");
            var msg = JSON.parse(event.data);
            if (msg.topic) {
                writeLog(msg.topic + "<br>" + msg.value + "<br>" + msg.metadata);
                var msgVal = JSON.parse(msg.value);
                var tblID = "table_"+msg.topic;
                var msgMetadata = JSON.parse(msg.metadata);
                writeLog("Parsed value: " + JSON.stringify(msgVal));
                if (document.getElementById(tblID) == null) {
                    writeLog("Creating table");
                    var table = document.createElement('table');
                    table.id = tblID;
                    var row = document.createElement('tr');
                    var col = 0;
                    for (var k in msgVal){
                        if (col == 0) {
                            table.setAttribute('keyFieldName',k);
                        }
                        //writeLog('Comparing ' + msgMetadata.timestampCol + ' with ' + k);
                        if (msgMetadata.timestampCol === k) {
                            writeLog("Adding key " + k + ' as timestamp attribute');
                            table.setAttribute('timestampFieldName',k);
                        }
                        //writeLog("Doing key " + k);
                        row.appendChild(document.createElement('th'));
                        row.cells[col].appendChild(document.createTextNode(k));
                        //}
                        col++;
                    }
                    table.appendChild(row);
                    tableArea.appendChild(table);
                } else {
                    writeLog("Found existing table");
                }

                var t = document.getElementById(tblID);
                var rowID = tblID + "._." + msgVal[t.getAttribute('keyFieldName')];
                writeLog("Row ID will be: " + rowID);

                if (document.getElementById(rowID) != null){
                    var r = document.getElementById(rowID);
                    var colNum = 0;
                    // TODO timestamp comparison.
                    for (var k in msgVal) {
                        // TODO check for null:
                        // if (data[member] != null)
                        r.cells[colNum].innerHTML = msgVal[k];
                        colNum++;
                    }

                } else {
                    var rowToInsert;
                    // Loop through the rows until we find the one that is alphabetically after the one we're inserting
                    // If the row doesn't exist it'll create it.
                    for (var rowToInsert = 1, row; row = t.rows[rowToInsert] && t.rows[rowToInsert].id < rowID; rowToInsert++){
                        ;
                    }

                    var newRow = t.insertRow(rowToInsert);
                    newRow.id = rowID;
                    var colNum = 0;
                    for (var k in msgVal) {
                        newRow.appendChild(document.createElement('td'));
                        newRow.cells[colNum].appendChild(document.createTextNode(msgVal[k]));
                        colNum++;
                    }
                }

                //TODO add highlighting of the row, green/red/yellow based on status

            } else {
                var txt = JSON.parse(event.data);
                if (txt.message === 'QUERIES_COMPLETE'){
                    writeLog("Received " + src + " message: QUERIES COMPLETE");
                    qrySource.close();
                    writeLog("Closed the query source connection");
                } else {
                    var lu = document.getElementById("lastUpdate");
                    lu.innerHTML = "Last server heartbeat received: " + txt.time;
                    writeLog("Received " + src + " heartbeat: " + JSON.stringify(txt));
                }
            } // if there's a topic
        };

        var qrySource = new EventSource("../jobStatus/init" + srch);
        qrySource.onmessage = function(event) {
            processEvent(event, 'QUERY');
        };

        var msgSource = new EventSource("../jobStatus/updates" + srch);
        msgSource.onmessage = function(event) {
            processEvent(event, 'MESSAGE');
        };

    </script>
</head>
<body>
<div id="tableArea"></div>
<div id="lastUpdate">
    <p>Last server heartbeat received: </p>
</div>
<div id="logArea" style="visibility: visible"></div>
</body>
</html>