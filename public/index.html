<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="stylesheets/style.css">
    <meta charset="UTF-8">
    <title>Job Tracker</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script>
        // assume that API service is published on same server that is the server of this HTML file
        // send event to SSE stream
        /* "{\"nrs\":[{\"code\":\"FR\",\"name\":\"France\",\"population\":66836154,\"size\":643801,\"continent\":\"Europe\"},{\"code\":\"DE\",\"name\":\"Germany\",\"population\":80722792,\"size\":357022,\"continent\":\"Europe\"},{\"code\":\"FI\",\"name\":\"Finland\",\"population\":5498211,\"size\":338145,\"continent\":\"Europe\"},null]}"
    update all Sse Client with message {"nrs":[{"code":"FR","name":"France","population":66836154,"size":643801,"continent":"Europe"},{"code":"DE","name":"Germany","population":80722792,"size":357022,"continent":"Europe"},{"code":"FI","name":"Finland","population":5498211,"size":338145,"continent":"Europe"},null]}
    */

        var source = new EventSource("../jobStatus/updates");
        source.onmessage = function(event) {

            var writeLog = function(logMsg){
                if (document.getElementById("logArea").style.visibility === 'visible') {
                    var logA = document.getElementById("logArea");
                    logA.innerHTML = logMsg + "<br>" + logA.innerHTML;
                }
            }

            var logArea = document.getElementById("logArea");
            var tableArea = document.getElementById("tableArea");
            var msg = JSON.parse(event.data);
            if (msg.topic) {
                //logArea.innerHTML = msg.topic + "<br>" + msg.value + "<br>" + logArea.innerHTML;
                writeLog(msg.topic + "<br>" + msg.value);
                var msgVal = JSON.parse(msg.value);
                var tblID = "table_"+msg.topic;
                writeLog("Parsed value: " + msgVal);
                if (document.getElementById(tblID) == null) {
                    writeLog("Creating table");
                    var table = document.createElement('table');
                    table.id = tblID;
                    var row = document.createElement('tr');
                    var col = 0;
                    for (var k in msgVal){
                        if (col == 0) {
                            table.setAttribute('keyFieldName',k)
                        }
                        writeLog("Doing key " + k);
                        row.appendChild(document.createElement('th'));
                        row.cells[col].appendChild(document.createTextNode(k));
                        col++;
                    }
                    table.appendChild(row);
                    tableArea.appendChild(table);
                } else {
                    writeLog("Found existing table");
                }

                var t = document.getElementById(tblID);
                var rowID = tblID + "._." + msgVal[t.getAttribute('keyFieldName')];
                writeLog("Row ID will be: " + rowID);

                if (document.getElementById(rowID) != null){
                    var r = document.getElementById(rowID);
                    var colNum = 0;
                    for (var k in msgVal) {
                        r.cells[colNum].innerHTML = msgVal[k];
                        colNum++;
                    }

                } else {
                    var rowToInsert;
                    for (var rowToInsert = 1, row; row = t.rows[rowToInsert] && t.rows[rowToInsert].id < rowID; rowToInsert++){
                        ;
                    }

                    var newRow = t.insertRow(rowToInsert);
                    newRow.id = rowID;
                    var colNum = 0;
                    for (var k in msgVal) {
                        newRow.appendChild(document.createElement('td'));
                        newRow.cells[colNum].appendChild(document.createTextNode(msgVal[k]));
                        colNum++;
                    }
                }

            } else {
                var lu = document.getElementById("lastUpdate");
                var txt = JSON.parse(event.data);
                lu.innerHTML = "Last server heartbeat received: " + txt.time;
            } // if there's a topic

        };//onMessage
    </script>
</head>
<body>
<div id="tableArea"></div>
<div id="lastUpdate">
    <p>Last server heartbeat received: </p>
</div>
<div id="logArea" style="visibility: hidden"></div>
</body>
</html>